# 邮件队列系统

## 概述

为了解决并发发送邮件时可能遇到的问题（如API限制、网络超时等），我们实现了一个简单的邮件队列系统。该系统使用内存队列来管理邮件发送任务，确保邮件能够有序、可靠地发送。

## 功能特性

### 1. 队列管理
- **优先级队列**：支持设置邮件发送优先级，高优先级邮件优先处理
- **并发控制**：最多同时处理3个邮件任务，避免API限制
- **自动重试**：发送失败的邮件会自动重试，最多重试3次
- **状态跟踪**：实时跟踪队列状态（等待中、处理中、已完成、失败）

### 2. 队列状态
- **等待队列**：已添加但尚未处理的邮件任务
- **处理中队列**：正在发送的邮件任务
- **已完成**：成功发送的邮件数量
- **失败**：发送失败且重试次数已用完的邮件数量

### 3. 重试机制
- 发送失败的邮件会自动重试
- 每次重试会降低任务优先级
- 最多重试3次，超过后标记为失败

## 系统架构

### 核心组件

1. **EmailQueue** (`lib/email/emailQueue.ts`)
   - 队列管理类
   - 处理邮件发送任务
   - 管理重试逻辑

2. **EmailService** (`lib/email/emailService.ts`)
   - 邮件服务类
   - 提供队列接口和直接发送接口

3. **队列API** (`app/api/email-queue/route.ts`)
   - 提供队列状态查询接口

4. **管理界面**
   - 邮件模板编辑器中的队列状态显示
   - 专门的队列管理页面 (`/admin/email-queue`)

### 工作流程

```
用户操作 → 添加邮件到队列 → 队列处理 → 发送邮件 → 更新状态
    ↓              ↓              ↓           ↓          ↓
  订单状态变更   优先级排序    并发控制    重试机制   状态跟踪
```

## 使用方法

### 1. 发送邮件（推荐方式）

```typescript
import { emailService } from '@/lib/email/emailService'

// 发送订单状态邮件（自动添加到队列）
const result = await emailService.sendOrderStatusEmail({
  to: 'user@example.com',
  userName: '张三',
  orderNumber: 'ORD-001',
  status: 'CONFIRMED',
  // ... 其他参数
})

if (result.success) {
  console.log('邮件已添加到队列，任务ID:', result.data.jobId)
}
```

### 2. 查看队列状态

```typescript
import { getQueueStats, getQueueStatus } from '@/lib/email/emailQueue'

// 获取统计信息
const stats = getQueueStats()
console.log('队列统计:', stats)

// 获取详细状态
const status = getQueueStatus()
console.log('详细状态:', status)
```

### 3. API接口

```bash
# 获取队列统计
GET /api/email-queue

# 获取详细状态
GET /api/email-queue?detailed=true
```

## 管理界面

### 1. 邮件模板编辑器
在邮件模板编辑器的顶部显示队列状态：
- 等待中的任务数
- 处理中的任务数
- 已完成的任务数
- 失败的任务数

### 2. 队列管理页面
访问 `/admin/email-queue` 查看详细的队列信息：
- 实时统计卡片
- 等待队列列表
- 处理中队列列表
- 队列说明文档

## 配置选项

### 队列配置
```typescript
// 在 EmailQueue 类中可以调整以下参数
private maxConcurrent = 3        // 最大并发数
private processingInterval = 1000 // 处理间隔（毫秒）
maxRetries = 3                   // 最大重试次数
```

### 优先级设置
```typescript
// 添加邮件到队列时可以设置优先级
await addEmailToQueue(emailParams, priority)

// 优先级说明：
// 1-2: 低优先级
// 3-4: 中优先级  
// 5+: 高优先级
```

## 监控和日志

### 控制台日志
系统会在控制台输出详细的队列操作日志：
- 任务添加到队列
- 任务开始处理
- 任务完成或失败
- 重试操作

### 状态监控
通过管理界面可以实时监控：
- 队列长度
- 处理速度
- 失败率
- 任务详情

## 测试

### 运行测试脚本
```bash
# 测试脚本已删除，请使用邮件模板编辑器进行测试
```

### 手动测试
1. 访问邮件模板编辑器
2. 发送测试邮件
3. 查看队列状态更新
4. 访问队列管理页面查看详细信息

## 注意事项

1. **内存队列**：当前实现使用内存队列，服务器重启后队列会清空
2. **并发限制**：最多同时处理3个邮件，避免API限制
3. **重试机制**：失败邮件会自动重试，但不会无限重试
4. **状态持久化**：队列状态仅在内存中，不持久化到数据库

## 未来改进

1. **数据库持久化**：将队列状态保存到数据库
2. **Redis队列**：使用Redis作为队列后端
3. **邮件发送记录**：记录所有邮件发送历史
4. **失败通知**：邮件发送失败时通知管理员
5. **批量发送**：支持批量邮件发送功能

## 故障排除

### 常见问题

1. **邮件发送失败**
   - 检查API密钥配置
   - 查看控制台错误日志
   - 确认邮件模板配置

2. **队列不处理**
   - 检查队列是否启动
   - 查看处理间隔设置
   - 确认并发限制

3. **状态不更新**
   - 检查自动刷新设置
   - 查看网络连接
   - 确认API接口正常

### 调试方法

1. 查看控制台日志
2. 访问队列管理页面
3. 使用邮件模板编辑器验证
4. 检查网络请求
